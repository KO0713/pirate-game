<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>é»’ã²ã’ãƒ­ã‚¹ã‚«ãƒƒãƒˆå ã„</title>

  <!-- GA4 ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ¸¬å®šIDã¯ã”è‡ªèº«ã®ã‚‚ã®ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼‰ -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7KN8SBQTZ8"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-7KN8SBQTZ8');
  </script>

  <style>
    /* ======== å…¨ä½“è¨­å®š ======== */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      text-align: center;
      background: url('tamatebako_background.png') no-repeat center/cover;
      color: #333;
    }
    /* ======== é¡Œåã‚’å¤ªãå¤§ãã ======== */
    h1 {
      font-size: 2.4em;
      font-weight: 900;
      font-family: "Impact", sans-serif;
      background: #f9a825;
      color: #fff;
      margin: 0;
      padding: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }
    .header-image {
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
      display: block;
      border-radius: 10px;
    }
    .container {
      margin: 10px auto 40px auto;
      text-align: center;
      max-width: 600px;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      padding-bottom: 20px;
    }
    .container h2 {
      margin-top: 0;
      padding: 10px;
      font-weight: bold;
    }
    /* ======== ã‚²ãƒ¼ãƒ ç”»åƒ ======== */
    .image {
      width: 360px;
      max-width: 90%;
      margin: 0 auto 10px auto;
      display: block;
    }
    /* ======== ãƒ‘ãƒãƒ«é…ç½® ======== */
    .panels {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 400px;
      margin: 0 auto;
    }
    .panel {
      width: 80px;
      height: 80px;
      margin: 10px;
      background: #ddd;
      border-radius: 10px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s;
    }
    .panel:hover {
      background: #ccc;
    }
    .panel.selected {
      background: #ff9800; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
      color: #fff;
      cursor: not-allowed;
    }
    /* ======== çµæœè¡¨ç¤º ======== */
    .result {
      font-size: 28px;
      font-weight: bold;
      margin: 10px;
      padding: 15px;
      background: #ffeb3b;
      color: #d32f2f;
      border-radius: 10px;
      display: inline-block;
    }
    /* ======== å„ç¨®ãƒœã‚¿ãƒ³ãƒ»ãƒªãƒ³ã‚¯ ======== */
    .cta-link {
      font-size: 20px;
      color: #000; 
      text-decoration: none;
      margin: 20px 10px;
      padding: 15px 20px;
      background: #ffeb3b;
      border-radius: 10px;
      display: inline-block;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }
    .cta-link:hover {
      background: #ffc107;
    }
    .reset-btn, .continue-btn {
      display: inline-block;
      padding: 12px 20px;
      margin-top: 20px;
      margin-right: 5px;
      background: #ff9800;
      color: #fff;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .reset-btn:hover, .continue-btn:hover {
      background: #fb8c00;
    }
    /* ======== ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ======== */
    .ranking {
      margin: 20px auto;
      max-width: 500px;
      background: #fafafa;
      padding: 15px;
      border-radius: 10px;
      text-align: left;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .ranking h2 {
      color: #ff9800;
      margin-bottom: 10px;
    }
    .ranking ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .ranking li {
      margin: 5px 0;
      font-weight: bold;
      color: #333;
    }
    /* ======== ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ› ======== */
    .nickname-container {
      margin: 20px;
    }
    .nickname-input {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-right: 10px;
    }
    .submit-nickname-btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background: #ff9800;
      color: #fff;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      cursor: pointer;
    }
    .submit-nickname-btn:hover {
      background: #fb8c00;
    }
    /* ======== ãªã‚“ã§ã‚‚ç›¸è«‡ãƒœã‚¿ãƒ³ ======== */
    .consult-btn {
      display: inline-block;
      font-size: 20px;
      color: #000;
      text-decoration: none;
      margin: 20px 10px;
      padding: 15px 20px;
      background: #80deea; /* ã‚·ã‚¢ãƒ³ç³» */
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }
    .consult-btn:hover {
      background: #4dd0e1;
    }
  </style>
</head>
<body>
  <h1>é»’ã²ã’ãƒ­ã‚¹ã‚«ãƒƒãƒˆå ã„</h1>

  <!-- æµ·è³Šã‚¤ãƒ¡ãƒ¼ã‚¸ï¼špirate_main_visual.pngã‚’ä½¿ã†æƒ³å®š -->
  <img src="pirate_main_visual.png" alt="Pirate Main Visual" class="header-image">

  <div class="container">
    <h2>ã•ã‚ã€é‹å‘½ã®æŒ‘æˆ¦ã‚’å§‹ã‚ã‚ˆã†ï¼</h2>

    <!-- ã‚²ãƒ¼ãƒ ç”»åƒ -->
    <img id="blackbeardImg" src="blackbeard_in_barrel.png" alt="é»’ã²ã’" class="image">

    <!-- ãƒ‘ãƒãƒ«è¡¨ç¤ºé ˜åŸŸ -->
    <div class="panels" id="panels"></div>

    <!-- çµæœè¡¨ç¤º -->
    <div id="result" class="result" style="display:none;"></div>

    <!-- ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆèª˜å°ãƒªãƒ³ã‚¯ï¼ˆå‹åˆ© or ãƒ­ã‚¹ã‚«ãƒƒãƒˆæ™‚ï¼‰-->
    <a id="opchatLink" class="cta-link" href="#" target="_blank" style="display: none;"
       onclick="gtag('event', 'click_opchat');">
       ã‚‚ã£ã¨è©³ã—ãå­¦ã¶ï¼OCå‚åŠ ã¯ã“ã¡ã‚‰
    </a>

    <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ & ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ -->
    <button id="resetBtn" class="reset-btn" style="display: none;">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="continueBtn" class="continue-btn" style="display: none;">ã•ã‚‰ã«ç¶šã‘ã‚‹</button>

    <!-- ãªã‚“ã§ã‚‚ç›¸è«‡ãƒœã‚¿ãƒ³ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰-->
    <a id="consultBtn" class="consult-btn" href="https://onl.bz/9jH3j8q" target="_blank"
       onclick="gtag('event','click_consult');">
      ãªã‚“ã§ã‚‚ç›¸è«‡
    </a>

    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ² -->
    <div class="nickname-container">
      <input id="nicknameInput" class="nickname-input" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›">
      <button id="submitNicknameBtn" class="submit-nickname-btn">ç™»éŒ²</button>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º -->
    <div class="ranking" id="ranking" style="display: none;">
      <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <ul id="rankingList"></ul>
    </div>
  </div>

  <script>
    // ============================
    // 1) ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç™½ç´™ã«æˆ»ã™
    // ============================
    localStorage.removeItem('pirateRanking');

    // ============================
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ç”¨ã®å¤‰æ•°
    // ============================
    let sessionReturns = 0;    // ä»Šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã€Œ3å›é€£ç¶šåˆ©ç¢ºã€ã‚’ä½•å›é”æˆã—ãŸã‹
    let isFirstGame    = true; // æœ€åˆã®ã‚²ãƒ¼ãƒ ã¯ãƒã‚ºãƒ¬ãªã—
    let currentNickname = "";  // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  (æœªå…¥åŠ›â†’åŒ¿å)
    let playerRanking  = [];   // ãƒ©ãƒ³ã‚­ãƒ³ã‚°(ãƒ¡ãƒ¢ãƒªä¸Š)

    // ã‚²ãƒ¼ãƒ é–¢é€£
    const MAX_ATTEMPTS = 3;
    const TOTAL_PANELS = 8;
    let attempts       = 0;    // ã„ã¾ä½•å›åˆºã—ãŸã‹
    let isGameOver     = false;
    let unluckyNumber  = -1;   // ãƒã‚ºãƒ¬ç•ªå·ï¼ˆåˆæœŸã¯-1ã§ãƒã‚ºãƒ¬ãªã—ã¨ã™ã‚‹ï¼‰

    // è¦ç´ å–å¾—
    const panelsContainer   = document.getElementById('panels');
    const blackbeardImg     = document.getElementById('blackbeardImg');
    const resultDiv         = document.getElementById('result');
    const opchatLink        = document.getElementById('opchatLink');
    const resetBtn          = document.getElementById('resetBtn');
    const continueBtn       = document.getElementById('continueBtn');
    const consultBtn        = document.getElementById('consultBtn');
    const nicknameInput     = document.getElementById('nicknameInput');
    const submitNicknameBtn = document.getElementById('submitNicknameBtn');
    const rankingDiv        = document.getElementById('ranking');
    const rankingList       = document.getElementById('rankingList');

    // ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆèª˜å°å…ˆï¼ˆå‹ã¡/è² ã‘ã§åˆ‡ã‚Šæ›¿ãˆï¼‰
    const OPC_LINK_WIN  = "https://onl.bz/88yuzHS?utm_source=PirateGameWin";
    const OPC_LINK_LOSS = "https://onl.bz/88yuzHS?utm_source=PirateGameLoss";

    // ============================
    // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
    // ============================
    function initGame() {
      panelsContainer.innerHTML   = '';
      blackbeardImg.src           = "blackbeard_in_barrel.png";
      resultDiv.style.display     = 'none';
      resultDiv.textContent       = '';
      opchatLink.style.display    = 'none';
      resetBtn.style.display      = 'none';
      continueBtn.style.display   = 'none';

      attempts   = 0;
      isGameOver = false;

      // 1å›ç›®ã®æŒ‘æˆ¦ã¯ãƒã‚ºãƒ¬ç„¡ã—ã€ãã‚Œä»¥é™ã¯ãƒ©ãƒ³ãƒ€ãƒ 
      if (isFirstGame) {
        unluckyNumber = -1; 
        isFirstGame   = false;
      } else {
        unluckyNumber = Math.floor(Math.random() * TOTAL_PANELS);
      }

      generatePanels();
    }

    // ãƒ‘ãƒãƒ«ç”Ÿæˆ
    function generatePanels() {
      for (let i = 0; i < TOTAL_PANELS; i++) {
        const panel = document.createElement('div');
        panel.className     = 'panel';
        panel.textContent   = i + 1;
        panel.dataset.index = i;
        panel.addEventListener('click', handlePanelClick);
        panelsContainer.appendChild(panel);
      }
    }

    // ãƒ‘ãƒãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚
    function handlePanelClick(e) {
      if (isGameOver) return;
      const panel = e.currentTarget;
      const index = parseInt(panel.dataset.index);

      if (panel.classList.contains('selected')) return;
      panel.classList.add('selected');

      attempts++;

      // ãƒã‚ºãƒ¬ã ã£ãŸï¼Ÿ
      if (index === unluckyNumber) {
        handleUnluckyResult();
      } else {
        // åˆ©ç¢º
        if (attempts < MAX_ATTEMPTS) {
          // 3å›ã«æº€ãŸãªã„ â†’ã€Œåˆ©ç¢ºï¼ã€è¡¨ç¤º
          resultDiv.textContent    = "åˆ©ç¢ºï¼";
          resultDiv.style.display  = 'inline-block';
          resultDiv.style.background = '#ffeb3b';
          resultDiv.style.color      = '#d32f2f';
        } else {
          // 3å›é€£ç¶šåˆ©ç¢º â†’ sessionReturns++
          sessionReturns++;
          handleVictory();
        }
      }
    }

    // ãƒ­ã‚¹ã‚«ãƒƒãƒˆ(è² ã‘)
    function handleUnluckyResult() {
      isGameOver = true;
      blackbeardImg.src = "blackbeard_out.png";

      resultDiv.innerHTML       = "ãƒ­ã‚¹ã‚«ãƒƒãƒˆï¼ã–ã‚“ã­ã‚“ï¼<br>æ¬¡ã“ãæˆåŠŸã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼";
      resultDiv.style.display   = 'inline-block';
      resultDiv.style.background= '#ffeb3b';
      resultDiv.style.color     = '#d32f2f';

      opchatLink.textContent = "ãƒ­ã‚¹ã‚«ãƒƒãƒˆå›é¿ã®ç§˜è¨£ã‚’å­¦ã¶ï¼OCå‚åŠ ";
      opchatLink.href        = OPC_LINK_LOSS;
      opchatLink.style.display = "inline-block";

      resetBtn.style.display    = "inline-block";
      continueBtn.style.display = "none";

      // è² ã‘ãŸã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº† â†’ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²(ã‚»ãƒƒã‚·ãƒ§ãƒ³Returns)
      updateRanking();
      displayRanking();

      // ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯çµ‚äº† â†’ æ¬¡å›ãƒªã‚»ãƒƒãƒˆãŒå§‹ã¾ã‚‹ã¾ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³Returnsã¯ç¶­æŒã—ãªã„
      sessionReturns = 0;
    }

    // å‹ã¡(3é€£ç¶šåˆ©ç¢º)
    function handleVictory() {
      isGameOver = true;
      blackbeardImg.src = "blackbeard_in_barrel.png";

      // æ”¹è¡Œã—ã¦ã‚ã‹ã‚Šã‚„ã™ã
      resultDiv.innerHTML = `ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™â€¼ï¸ğŸŠãŠ—ï¸<br>${sessionReturns}å›ç›®ã®åŸè³‡å›åã§ã™â€¼ï¸âœ¨`;
      resultDiv.style.display   = 'inline-block';
      resultDiv.style.background= '#ffeb3b';
      resultDiv.style.color     = '#d32f2f';

      opchatLink.textContent = "ãƒªã‚¢ãƒ«ã§ã‚‚æˆåŠŸã‚’ç›®æŒ‡ã™ï¼OCå‚åŠ ";
      opchatLink.href        = OPC_LINK_WIN;
      opchatLink.style.display = "inline-block";

      resetBtn.style.display    = "inline-block";
      continueBtn.style.display = "inline-block";
    }

    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    function resetGame() {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº† â†’ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²
      updateRanking();
      displayRanking();

      // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸(æœ€åˆã«æˆ»ã‚‹)
      sessionReturns = 0;
      isFirstGame    = true;
      initGame();
    }

    // ã•ã‚‰ã«ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ï¼ˆå‹åˆ©å¾Œã«æ¬¡ã®ã‚²ãƒ¼ãƒ ï¼‰
    function continueGame() {
      // å‹åˆ©ç¢ºå®š â†’ ã¾ã è² ã‘ã¦ãªã„ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶šè¡Œ
      // ã“ã“ã§ã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²ã—ãªã„ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ï¼‰
      displayRanking();
      initGame();
    }

    // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç™»éŒ²
    submitNicknameBtn.addEventListener('click', () => {
      const nickname = nicknameInput.value.trim();
      if (nickname) {
        currentNickname = nickname;
        nicknameInput.value = '';
        alert(`ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€Œ${currentNickname}ã€ã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ï¼`);
      } else {
        currentNickname = "åŒ¿å";
        alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æœªå…¥åŠ›ã®ãŸã‚ã€ã€ŒåŒ¿åã€ã§ç™»éŒ²ã—ã¾ã™ï¼');
      }
    });

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²
    function updateRanking() {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ãŸã®ã§ã€sessionReturnsã‚’ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ 
      if (!currentNickname) currentNickname = "åŒ¿å";
      const existing = playerRanking.find(r => r.nickname === currentNickname);
      if (existing) {
        existing.returns = Math.max(existing.returns, sessionReturns);
        // â†‘ ä¸Šæ›¸ã or åŠ ç®—ï¼šè¦ä»¶ã«å¿œã˜ã¦å¤‰æ›´
        //   ã‚‚ã—ã€Œä¸Šæ›¸ãã€ã§ã¯ãªãã€ŒåŠ ç®—ã€ã«ã—ãŸã„ãªã‚‰:
        //   existing.returns += sessionReturns;
      } else {
        playerRanking.push({ nickname: currentNickname, returns: sessionReturns });
      }
      // åŸè³‡å›åãŒå¤šã„é †
      playerRanking.sort((a, b) => b.returns - a.returns);
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
    function displayRanking() {
      rankingList.innerHTML = '';
      playerRanking.forEach((rank, index) => {
        const li = document.createElement('li');
        li.textContent = `${index + 1}ä½: åŸè³‡å›å${rank.returns}å› (${rank.nickname})`;
        rankingList.appendChild(li);
      });
      rankingDiv.style.display = (playerRanking.length > 0) ? 'block' : 'none';
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰
    window.addEventListener('DOMContentLoaded', () => {
      initGame();
      displayRanking();
    });

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    resetBtn.addEventListener('click', resetGame);
    continueBtn.addEventListener('click', continueGame);
  </script>
</body>
</html>
